function initializeStage(stageNumber) {
            const stage = gameState.stages[stageNumber];
            if (!stage) return;

            // ë°°ê²½ ë³€ê²½
            gameContainer.style.backgroundImage = `url('${stage.background}')`;
            
            // ìŠ¤í…Œì´ì§€ ì œëª© ì—…ë°ì´íŠ¸
            const stageEmojis = ['ğŸ”ï¸', 'ğŸŒ²', 'ğŸ°'];
            stageTitle.textContent = `${stageEmojis[stageNumber - 1]} ${stage.name}`;

            // ê¸°ì¡´ ë™ì  ìš”ì†Œë“¤ ì œê±°
            document.querySelectorAll('.dynamic-npc, .dynamic-spot').forEach(el => el.remove());

            // NPCë“¤ ìƒì„±
            stage.npcs.forEach((npcData, index) => {
                const npcElement = document.createElement('div');
                npcElement.className = 'npc dynamic-npc';
                npcElement.dataset.npc = npcData.id;
                npcElement.style.left = npcData.x + 'px';
                npcElement.style.top = npcData.y + 'px';
                
                const npcEmojis = {
                    painter: 'ğŸ‘¨â€ğŸ¨', merchant: 'ğŸ‘¨â€ğŸ’¼', artist: 'ğŸ‘©â€ğŸ¨',
                    fairy: 'ğŸ§šâ€â™€ï¸', wizard: 'ğŸ§™â€â™‚ï¸', elf: 'ğŸ§â€â™‚ï¸',
                    dragon: 'ğŸ‰', knight: 'âš”ï¸', princess: 'ğŸ‘¸'
                };
                
                npcElement.innerHTML = `
                    ${npcEmojis[npcData.id] || 'ğŸ‘¤'}
                    <div class="npc-indicator" style="display: ${npcData.talked ? 'none' : 'flex'}">!</div>
                `;
                
                npcElement.addEventListener('click', () => startDialog(npcData.id));
                gameContainer.appendChild(npcElement);
            });

            // ê·¸ë¦¼ ì¥ì†Œë“¤ ìƒì„±
            stage.drawingSpots.forEach((spotData, index) => {
                const spotElement = document.createElement('div');
                spotElement.className = 'drawing-spot dynamic-spot';
                spotElement.id = spotData.id;
                spotElement.style.left = spotData.x + 'px';
                spotElement.style.top = spotData.y + 'px';
                
                const spotEmojis = {
                    1: ['ğŸŒ…', 'ğŸ”ï¸', 'ğŸŒ¸', 'ğŸŒŠ'],
                    2: ['ğŸŒ³', 'ğŸŒ™', 'ğŸŒ¿', 'ğŸŒˆ'],
                    3: ['ğŸ’', 'ğŸ‘‘', 'ğŸŒ…', 'âœ¨']
                };
                
                spotElement.innerHTML = spotData.used ? 'âœ…' : spotEmojis[stageNumber][index];
                if (spotData.used) {
                    spotElement.classList.add('used');
                }
                
                gameContainer.appendChild(spotElement);
            });

            // í¬í„¸ ìƒíƒœ ì—…ë°ì´íŠ¸
            updatePortals();
        }

        function updatePortals() {
            // ì™¼ìª½ í¬í„¸ (ì´ì „ ìŠ¤í…Œì´ì§€)
            if (gameState.currentStage <= 1) {
                leftPortal.classList.add('locked');
                leftPortal.style.opacity = '0.3';
                leftPortal.style.cursor = 'not-allowed';
            } else {
                leftPortal.classList.remove('locked');
                leftPortal.style.opacity = '1';
                leftPortal.style.cursor = 'pointer';
            }

            // ì˜¤ë¥¸ìª½ í¬í„¸ (ë‹¤ìŒ ìŠ¤í…Œì´ì§€)
            const currentStage = gameState.stages[gameState.currentStage];
            const allCompleted = currentStage.drawingSpots.every(spot => spot.used);
            
            if (gameState.currentStage >= gameState.maxStage || !allCompleted) {
                rightPortal.classList.add('locked');
                rightPortal.style.opacity = allCompleted ? '1' : '0.3';
                if (!allCompleted) {
                    rightPortal.style.cursor = 'not-allowed';
                } else {
                    rightPortal.style.cursor = 'pointer';
                }
            } else {
                rightPortal.classList.remove('locked');
                rightPortal.style.opacity = '1';
                rightPortal.style.cursor = 'pointer';
            }
        }

        function goToPreviousStage() {
            if (gameState.currentStage <= 1 || gameState.character.isDrawing || gameState.character.isInDialog) return;

            gameState.currentStage--;
            transitionToStage();
        }

        function goToNextStage() {
            const currentStage = gameState.stages[gameState.currentStage];
            const allCompleted = currentStage.drawingSpots.every(spot => spot.used);
            
            if (!allCompleted) {
                showMessage('âŒ ëª¨ë“  ì‘í’ˆì„ ì™„ì„±í•´ì•¼ ë‹¤ìŒ ìŠ¤í…Œì´ì§€ë¡œ ê°ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤!');
                return;
            }
            
            if (gameState.currentStage >= gameState.maxStage || gameState.character.isDrawing || gameState.character.isInDialog) return;

            gameState.currentStage++;
            transitionToStage();
        }

        function transitionToStage() {
            // ì „í™˜ íš¨ê³¼ ì‹œì‘
            stageTransition.classList.add('active');
            gameState.character.isInDialog = true; // ì´ë™ ì¤‘ ìƒí˜¸ì‘ìš© ë°©ì§€

            setTimeout(() => {
                // ìºë¦­í„° ìœ„ì¹˜ ë¦¬ì…‹
                gameState.character.x = 100;
                gameState.character.y = 100;
                gameState.character.artworks = 0; // í˜„ì¬ ìŠ¤í…Œì´ì§€ ì‘í’ˆ ìˆ˜ ë¦¬ì…‹
                updateCharacterPosition();

                // ìƒˆ ìŠ¤í…Œì´ì§€ ì´ˆê¸°í™”
                initializeStage(gameState.currentStage);
                updateUI();

                // ìŠ¤í…Œì´ì§€ë³„ í™˜ì˜ ë©”ì‹œì§€
                const welcomeMessages = {
                    1: "ğŸ”ï¸ í‰í™”ë¡œìš´ ë§ˆì„ì— ë„ì°©í–ˆìŠµë‹ˆë‹¤!",
                    2: "ğŸŒ² ì‹ ë¹„í•œ ìˆ²ìœ¼ë¡œ ëª¨í—˜ì„ ë– ë‚¬ìŠµë‹ˆë‹¤!",
                    3: "ğŸ° ë“œë˜ê³¤ì˜ ì„±ì— ë„ë‹¬í–ˆìŠµë‹ˆë‹¤!"
                };

                showMessage(welcomeMessages[gameState.currentStage]);

                // ì „í™˜ íš¨ê³¼ ì¢…ë£Œ
                setTimeout(() => {
                    stageTransition.classList.remove('active');
                    gameState.character.isInDialog = false;
                }, 500);
            }, 500);
        }<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê·¸ë¦¼ìŸì´</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #000;
            color: #333;
            overflow: hidden;
            user-select: none;
        }

        .game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            background-image: url('background.jpg');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-color: #87CEEB;
        }

        /* ì‹œì‘ í™”ë©´ */
        .start-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(0,0,0,0.8), rgba(50,50,100,0.9));
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            transition: opacity 0.5s ease;
        }

        .start-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .title {
            font-size: 4rem;
            color: #FFD700;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.8);
            margin-bottom: 20px;
            animation: glow 2s ease-in-out infinite alternate;
        }

        @keyframes glow {
            from { text-shadow: 3px 3px 6px rgba(0,0,0,0.8), 0 0 20px #FFD700; }
            to { text-shadow: 3px 3px 6px rgba(0,0,0,0.8), 0 0 30px #FFD700, 0 0 40px #FFD700; }
        }

        .subtitle {
            font-size: 1.5rem;
            color: #FFF;
            margin-bottom: 40px;
            text-align: center;
        }

        .start-btn {
            background: linear-gradient(45deg, #FF6B6B, #FF8E53);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 30px;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
        }

        .start-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.4);
        }

        /* UI íŒ¨ë„ */
        .ui-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            z-index: 10;
            min-width: 200px;
        }

        .save-load-panel {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            z-index: 10;
        }

        /* ìºë¦­í„° */
        .character {
            position: absolute;
            width: 60px;
            height: 60px;
            background: #FF6B6B;
            border-radius: 50%;
            border: 3px solid #fff;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            z-index: 5;
            transition: transform 0.1s ease;
        }

        /* NPC */
        .npc {
            position: absolute;
            width: 70px;
            height: 70px;
            background: #4ECDC4;
            border-radius: 50%;
            border: 3px solid #fff;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 35px;
            cursor: pointer;
            z-index: 4;
            transition: all 0.3s ease;
        }

        .npc:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.5);
        }

        .npc-indicator {
            position: absolute;
            top: -10px;
            right: -10px;
            background: #FFD700;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        /* ëŒ€í™”ì°½ */
        .dialog-box {
            position: absolute;
            bottom: 50px;
            left: 50%;
            transform: translateX(-50%);
            width: 80%;
            max-width: 600px;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.5);
            z-index: 15;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .dialog-box.show {
            opacity: 1;
        }

        .dialog-name {
            color: #FFD700;
            font-weight: bold;
            margin-bottom: 10px;
            font-size: 1.2rem;
        }

        .dialog-text {
            font-size: 1.1rem;
            line-height: 1.4;
            margin-bottom: 15px;
        }

        .dialog-continue {
            text-align: right;
            color: #aaa;
            font-size: 0.9rem;
        }

        /* ë…ë°±ì°½ */
        .monologue-box {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 70%;
            max-width: 500px;
            background: rgba(100, 50, 150, 0.95);
            color: white;
            padding: 25px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.6);
            z-index: 20;
            opacity: 0;
            transition: opacity 0.3s ease;
            text-align: center;
            border: 2px solid #FFD700;
        }

        .monologue-box.show {
            opacity: 1;
        }

        .monologue-text {
            font-size: 1.3rem;
            line-height: 1.5;
            font-style: italic;
        }

        /* ê·¸ë¦¼ ì¥ì†Œ */
        .drawing-spot {
            position: absolute;
            width: 80px;
            height: 80px;
            background: rgba(255, 255, 0, 0.8);
            border: 3px dashed #FF8C00;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 3;
        }

        .drawing-spot:hover {
            background: rgba(255, 255, 0, 1);
            transform: scale(1.05);
        }

        .drawing-spot.used {
            background: rgba(0, 255, 0, 0.6);
            border-color: #228B22;
        }

        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .btn {
            background: linear-gradient(45deg, #FF6B6B, #FF8E53);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            margin: 2px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .btn.secondary {
            background: linear-gradient(45deg, #95a5a6, #7f8c8d);
        }

        /* ì§„í–‰ë°” */
        .progress-container {
            margin: 10px 0;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #ddd;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #45a049);
            width: 0%;
            transition: width 0.1s ease;
        }

        /* ë©”ì‹œì§€ */
        .message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            font-size: 18px;
            text-align: center;
            z-index: 25;
            opacity: 0;
            transition: opacity 0.3s ease;
            max-width: 400px;
        }

        .message.show {
            opacity: 1;
        }

        /* ì»¨íŠ¸ë¡¤ ì•ˆë‚´ */
        .controls-info {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px;
            border-radius: 10px;
            font-size: 12px;
        }

        /* í¬í„¸ ë¬¸ ìŠ¤íƒ€ì¼ */
        .portal {
            position: absolute;
            width: 80px;
            height: 120px;
            background: linear-gradient(145deg, #8B4513, #D2691E);
            border-radius: 15px 15px 5px 5px;
            border: 4px solid #654321;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 50px;
            cursor: pointer;
            z-index: 6;
            transition: all 0.4s ease;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
        }

        .portal:hover {
            transform: translateY(-50%) scale(1.1);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.6);
            background: linear-gradient(145deg, #A0522D, #DEB887);
        }

        .portal.locked {
            background: linear-gradient(145deg, #555, #777);
            cursor: not-allowed;
            opacity: 0.5;
        }

        .portal.locked:hover {
            transform: translateY(-50%) scale(1);
        }

        .portal-label {
            position: absolute;
            bottom: -25px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 10px;
            font-size: 12px;
            white-space: nowrap;
            pointer-events: none;
        }

        .right-portal:hover {
            transform: translateY(-50%) scale(1.1);
        }

        .left-portal:hover {
            transform: translateY(-50%) scale(1.1);
        }

        /* ìŠ¤í…Œì´ì§€ ì „í™˜ íš¨ê³¼ */
        .stage-transition {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(255,255,255,0) 0%, rgba(0,0,0,0.9) 70%);
            z-index: 50;
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        .stage-transition.active {
            opacity: 1;
        }
    </style>
</head>
<body>
    <!-- ì‹œì‘ í™”ë©´ -->
    <div class="start-screen" id="start-screen">
        <div class="title">ğŸ¨ ê·¸ë¦¼ìŸì´ì˜ ëª¨í—˜</div>
        <div class="subtitle">
            ê¿ˆê¾¸ëŠ” í™”ê°€ ì•„í‹°ì˜ ì´ì•¼ê¸°<br>
            ë§ˆì„ì„ ëŒì•„ë‹¤ë‹ˆë©° ê·¸ë¦¼ì„ ê·¸ë ¤ë³´ì„¸ìš”!
        </div>
        <button class="start-btn" id="start-game-btn">ëª¨í—˜ ì‹œì‘í•˜ê¸°</button>
    </div>

    <div class="game-container" id="game-container">
        <!-- UI íŒ¨ë„ -->
        <div class="ui-panel">
            <h3 id="stage-title">ğŸ”ï¸ í‰í™”ë¡œìš´ ë§ˆì„</h3>
            <p>ğŸ’° ê³¨ë“œ: <span id="gold-display">0</span></p>
            <p>ğŸ–¼ï¸ í˜„ì¬: <span id="artworks-display">0</span>/4</p>
            <p>ğŸ† ì´ ì‘í’ˆ: <span id="total-artworks">0</span></p>
            <div class="progress-container">
                <div class="progress-bar">
                    <div class="progress-fill" id="drawing-progress"></div>
                </div>
            </div>
            <p id="status">ë§ˆì„ì„ íƒí—˜í•´ë³´ì„¸ìš”!</p>
        </div>

        <!-- ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸° íŒ¨ë„ -->
        <div class="save-load-panel">
            <button class="btn" id="save-btn">ğŸ’¾ ì €ì¥</button>
            <button class="btn secondary" id="load-btn">ğŸ“‚ ë¶ˆëŸ¬ì˜¤ê¸°</button>
            <button class="btn secondary" id="reset-btn">ğŸ”„ ë¦¬ì…‹</button>
        </div>

        <!-- í¬í„¸ ë¬¸ë“¤ -->
        <div class="portal left-portal" id="left-portal" style="left: 20px; top: 50%; transform: translateY(-50%);">
            ğŸšª
            <div class="portal-label">ì´ì „ ìŠ¤í…Œì´ì§€</div>
        </div>
        <div class="portal right-portal" id="right-portal" style="right: 20px; top: 50%; transform: translateY(-50%);">
            ğŸšª
            <div class="portal-label">ë‹¤ìŒ ìŠ¤í…Œì´ì§€</div>
        </div>

        <!-- ìºë¦­í„° -->
        <div class="character" id="character">ğŸ¨</div>

        <!-- NPCë“¤ê³¼ ê·¸ë¦¼ ì¥ì†Œë“¤ì€ ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->

        <!-- ëŒ€í™”ì°½ -->
        <div class="dialog-box" id="dialog-box">
            <div class="dialog-name" id="dialog-name"></div>
            <div class="dialog-text" id="dialog-text"></div>
            <div class="dialog-continue">ìŠ¤í˜ì´ìŠ¤ë°”ë¥¼ ëˆŒëŸ¬ ê³„ì†...</div>
        </div>

        <!-- ë…ë°±ì°½ -->
        <div class="monologue-box" id="monologue-box">
            <div class="monologue-text" id="monologue-text"></div>
        </div>

        <!-- ë©”ì‹œì§€ ì°½ -->
        <div class="message" id="message"></div>

        <!-- ì»¨íŠ¸ë¡¤ ì•ˆë‚´ -->
        <div class="controls-info">
            ğŸ® í™”ì‚´í‘œí‚¤: ì´ë™ | ìŠ¤í˜ì´ìŠ¤ë°”: ìƒí˜¸ì‘ìš©/ëŒ€í™” | Eí‚¤: ê·¸ë¦¼ê·¸ë¦¬ê¸°
        </div>
    </div>

    <script>
        // ê²Œì„ ìƒíƒœ ê´€ë¦¬
        const gameState = {
            gameStarted: false,
            currentStage: 1,
            maxStage: 3,
            character: {
                x: 100,
                y: 100,
                gold: 0,
                artworks: 0,
                totalArtworks: 0,
                isDrawing: false,
                isInDialog: false
            },
            stages: {
                1: {
                    name: "í‰í™”ë¡œìš´ ë§ˆì„",
                    background: "village.jpg",
                    npcs: [
                        { 
                            id: 'painter', 
                            name: 'ìŠ¤ìŠ¹ í™”ê°€', 
                            talked: false,
                            x: 200, y: 150,
                            dialogs: [
                                "ì•ˆë…•í•˜ê²Œë‚˜, ì Šì€ í™”ê°€ì—¬! ë‚˜ëŠ” ì´ ë§ˆì„ì˜ í™”ê°€ ìŠ¤ìŠ¹ì´ë¼ë„¤.",
                                "ê·¸ë¦¼ì€ ë§ˆìŒìœ¼ë¡œ ê·¸ë¦¬ëŠ” ê²ƒì´ì•¼. ê¸°ìˆ ë„ ì¤‘ìš”í•˜ì§€ë§Œ ì—´ì •ì´ ë” ì¤‘ìš”í•˜ë‹¤ë„¤!",
                                "ë§ˆì„ ê³³ê³³ì— ì•„ë¦„ë‹¤ìš´ í’ê²½ë“¤ì´ ìˆìœ¼ë‹ˆ ì°¾ì•„ê°€ì„œ ê·¸ë ¤ë³´ê²Œë‚˜."
                            ]
                        },
                        { 
                            id: 'merchant', 
                            name: 'í™”êµ¬ ìƒì¸', 
                            talked: false,
                            x: 800, y: 450,
                            dialogs: [
                                "ì–´ì„œ ì˜¤ì„¸ìš”! ìµœê³ ê¸‰ í™”êµ¬ë§Œ íŒë§¤í•©ë‹ˆë‹¤.",
                                "ì¢‹ì€ ê·¸ë¦¼ì„ ê·¸ë¦¬ë ¤ë©´ ì¢‹ì€ ë„êµ¬ê°€ í•„ìš”í•˜ì£ .",
                                "ê³¨ë“œê°€ ëª¨ì´ë©´ ë” ì¢‹ì€ ë¶“ê³¼ ë¬¼ê°ì„ ì‚¬ëŸ¬ ì˜¤ì„¸ìš”!"
                            ]
                        },
                        { 
                            id: 'artist', 
                            name: 'ë™ë£Œ í™”ê°€', 
                            talked: false,
                            x: 600, y: 250,
                            dialogs: [
                                "ì•ˆë…•í•˜ì„¸ìš”! ì €ë„ ê·¸ë¦¼ì„ ê·¸ë¦¬ëŠ” í™”ê°€ì˜ˆìš”.",
                                "ì´ ë§ˆì„ì˜ í’ê²½ì€ ì •ë§ ì•„ë¦„ë‹¤ì›Œì„œ ì˜ê°ì´ ìƒ˜ì†Ÿì•„ìš”.",
                                "ê°™ì´ ì—´ì‹¬íˆ ê·¸ë¦¼ ì—°ìŠµí•´ìš”!"
                            ]
                        }
                    ],
                    drawingSpots: [
                        { id: 'spot1', used: false, reward: 80, name: 'ì•„ì¹¨ í’ê²½', location: 'ì–¸ë•', x: 150, y: 300 },
                        { id: 'spot2', used: false, reward: 120, name: 'ì„¤ì‚°', location: 'ë¶ìª½ ì‚°ë§¥', x: 500, y: 200 },
                        { id: 'spot3', used: false, reward: 100, name: 'ë²šê½ƒ', location: 'ë§ˆì„ ê³µì›', x: 400, y: 400 },
                        { id: 'spot4', used: false, reward: 90, name: 'ë°”ë‹¤', location: 'í•´ì•ˆê°€', x: 750, y: 350 }
                    ]
                },
                2: {
                    name: "ì‹ ë¹„í•œ ìˆ²",
                    background: "forest.jpg",
                    npcs: [
                        { 
                            id: 'fairy', 
                            name: 'ìˆ²ì˜ ìš”ì •', 
                            talked: false,
                            x: 300, y: 200,
                            dialogs: [
                                "ì–´ë¨¸, ì¸ê°„ í™”ê°€ê°€ ìš°ë¦¬ ìˆ²ì— ì™”ë„¤ìš”!",
                                "ì´ ìˆ²ì—ëŠ” ë§ˆë²•ì ì¸ í’ê²½ë“¤ì´ ê°€ë“í•´ìš”.",
                                "ì¡°ì‹¬ìŠ¤ëŸ½ê²Œ ê·¸ë ¤ì£¼ì„¸ìš”. ìì—°ì„ ì¡´ì¤‘í•˜ëŠ” ë§ˆìŒìœ¼ë¡œìš”."
                            ]
                        },
                        { 
                            id: 'wizard', 
                            name: 'ìˆ²ì˜ ë§ˆë²•ì‚¬', 
                            talked: false,
                            x: 700, y: 400,
                            dialogs: [
                                "ì Šì€ í™”ê°€ì—¬, ì—¬ê¸°ëŠ” ë§ˆë²•ì˜ ìˆ²ì´ë‹¤.",
                                "ê·¸ë¦¼ì— ë§ˆë²•ì„ ë‹´ì„ ìˆ˜ ìˆë‹¤ë©´... íŠ¹ë³„í•œ ì¼ì´ ì¼ì–´ë‚ ì§€ë„ ëª¨ë¥´ì§€.",
                                "ì§‘ì¤‘í•˜ê³  ì •ì„±ìŠ¤ëŸ½ê²Œ ê·¸ë ¤ë³´ê²Œ."
                            ]
                        },
                        { 
                            id: 'elf', 
                            name: 'ì—˜í”„ ê°€ë“œ', 
                            talked: false,
                            x: 500, y: 300,
                            dialogs: [
                                "ì´ë°©ì¸ì´ì—¬, ì´ ìˆ²ì˜ ì•„ë¦„ë‹¤ì›€ì„ ì–´ë–»ê²Œ í‘œí˜„í•  ê±´ê°€?",
                                "ìš°ë¦¬ ì—˜í”„ë“¤ë„ ì˜ˆìˆ ì„ ì‚¬ë‘í•œë‹¤ë„¤.",
                                "ì¢‹ì€ ì‘í’ˆì´ ë‚˜ì˜¤ê¸¸ ê¸°ëŒ€í•˜ê² ì–´."
                            ]
                        }
                    ],
                    drawingSpots: [
                        { id: 'fspot1', used: false, reward: 150, name: 'ë§ˆë²•ì˜ ë‚˜ë¬´', location: 'ê³ ëŒ€ ìˆ²', x: 200, y: 350 },
                        { id: 'fspot2', used: false, reward: 180, name: 'ìš”ì •ì˜ ì—°ëª»', location: 'ì‹ ë¹„í•œ ìƒ˜í„°', x: 600, y: 150 },
                        { id: 'fspot3', used: false, reward: 160, name: 'ë‹¬ë¹› í’€ë°­', location: 'ì—˜í”„ì˜ ì •ì›', x: 450, y: 450 },
                        { id: 'fspot4', used: false, reward: 140, name: 'ë¬´ì§€ê°œ í­í¬', location: 'ìˆ¨ê²¨ì§„ ê³„ê³¡', x: 800, y: 300 }
                    ]
                },
                3: {
                    name: "ë“œë˜ê³¤ì˜ ì„±",
                    background: "castle.jpg",
                    npcs: [
                        { 
                            id: 'dragon', 
                            name: 'ê³ ëŒ€ ë“œë˜ê³¤', 
                            talked: false,
                            x: 400, y: 200,
                            dialogs: [
                                "í¬í ... ì¸ê°„ í™”ê°€ê°€ ë‚´ ì„±ê¹Œì§€ ì˜¬ë¼ì™”êµ¬ë‚˜.",
                                "ìš©ê¸°ëŠ” ì¸ì •í•˜ê² ë‹¤. í•˜ì§€ë§Œ ì—¬ê¸°ëŠ” ì‰½ì§€ ì•Šì„ ê²ƒì´ì•¼.",
                                "ì§„ì •í•œ ì˜ˆìˆ ê°€ë¼ë©´... ë‚´ ë³´ë¬¼ë“¤ì„ ê·¸ë ¤ë³¼ ìˆ˜ ìˆì„ê¹Œ?"
                            ]
                        },
                        { 
                            id: 'knight', 
                            name: 'ìš©ê¸°ì‚¬', 
                            talked: false,
                            x: 150, y: 400,
                            dialogs: [
                                "ë“œë˜ê³¤ê³¼ ì‹¸ìš°ëŸ¬ ì™”ë‹¤ê°€... ê·¸ë¦¼ìŸì´ë¥¼ ë§Œë‚˜ëŠ”êµ°.",
                                "ì˜ˆìˆ ë¡œ ë“œë˜ê³¤ì˜ ë§ˆìŒì„ ì‚¬ë¡œì¡ëŠ”ë‹¤ë‹ˆ, í¥ë¯¸ë¡­êµ°.",
                                "ë‚˜ë„ ê·¸ ê²°ê³¼ê°€ ê¶ê¸ˆí•˜ë‹¤."
                            ]
                        },
                        { 
                            id: 'princess', 
                            name: 'ê³µì£¼', 
                            talked: false,
                            x: 700, y: 350,
                            dialogs: [
                                "ì˜¤! í™”ê°€ë‹˜ì´ì‹œêµ°ìš”! ì €ë„ ì˜ˆìˆ ì„ ì¢‹ì•„í•´ìš”.",
                                "ì´ ì„±ì—ëŠ” ì •ë§ ì¥ì—„í•œ í’ê²½ë“¤ì´ ë§ì•„ìš”.",
                                "ë©‹ì§„ ì‘í’ˆì„ ê¸°ëŒ€í• ê²Œìš”!"
                            ]
                        }
                    ],
                    drawingSpots: [
                        { id: 'cspot1', used: false, reward: 200, name: 'ë“œë˜ê³¤ì˜ ë³´ë¬¼', location: 'ë³´ë¬¼ ì°½ê³ ', x: 300, y: 300 },
                        { id: 'cspot2', used: false, reward: 250, name: 'ì™•ì¢Œì˜ ë°©', location: 'ëŒ€ê¶ì „', x: 500, y: 180 },
                        { id: 'cspot3', used: false, reward: 220, name: 'ì„±ë²½ì˜ ì¼ëª°', location: 'ë†’ì€ íƒ‘', x: 650, y: 400 },
                        { id: 'cspot4', used: false, reward: 180, name: 'ê³ ëŒ€ ë§ˆë²•ì§„', location: 'ì§€í•˜ ë˜ì „', x: 200, y: 450 }
                    ]
                }
            },
            story: {
                introShown: false,
                currentDialog: 0,
                currentNpc: null
            },
            keys: {
                up: false,
                down: false,
                left: false,
                right: false
            }
        };

        // NPC ëŒ€í™” ë°ì´í„°ì™€ ë…ë°±
        const monologues = [
            "ë“œë””ì–´ ê·¸ë¦¼ìŸì´ì˜ ê¸¸ì„ ì‹œì‘í•˜ëŠ”êµ°... ì„¤ë ˆëŠ” ë§ˆìŒì„ ê°ì¶œ ìˆ˜ ì—†ì–´.",
            "ì´ ë§ˆì„ì˜ ì•„ë¦„ë‹¤ìš´ í’ê²½ë“¤ì„ ëª¨ë‘ ê·¸ë ¤ë³´ê³  ì‹¶ì–´!",
            "ìŠ¤ìŠ¹ë‹˜ì˜ ë§ì”€ì²˜ëŸ¼ ë§ˆìŒìœ¼ë¡œ ê·¸ë ¤ì•¼ê² ì–´.",
            "ê³¨ë“œë„ ë²Œê³  ì‹¤ë ¥ë„ ëŠ˜ë¦¬ê³ ... ì¼ì„ì´ì¡°ë„¤!",
            "ëª¨ë“  ì‘í’ˆì„ ì™„ì„±í•˜ë©´ ì§„ì •í•œ í™”ê°€ê°€ ë  ìˆ˜ ìˆì„ ê±°ì•¼!",
            "ì‹ ë¹„í•œ ìˆ²ì˜ ë§ˆë²•ì„ ê·¸ë¦¼ìœ¼ë¡œ ë‹´ì•„ë³´ì!",
            "ë“œë˜ê³¤ì˜ ì„±... ì •ë§ ì›…ì¥í•œ ê³³ì´ì•¼!"
        ];

        // DOM ìš”ì†Œë“¤
        const startScreen = document.getElementById('start-screen');
        const startGameBtn = document.getElementById('start-game-btn');
        const gameContainer = document.getElementById('game-container');
        const stageTransition = document.getElementById('stage-transition');
        const character = document.getElementById('character');
        const stageTitle = document.getElementById('stage-title');
        const goldDisplay = document.getElementById('gold-display');
        const artworksDisplay = document.getElementById('artworks-display');
        const totalArtworksDisplay = document.getElementById('total-artworks');
        const statusDisplay = document.getElementById('status');
        const progressBar = document.getElementById('drawing-progress');
        const messageBox = document.getElementById('message');
        const dialogBox = document.getElementById('dialog-box');
        const dialogName = document.getElementById('dialog-name');
        const dialogText = document.getElementById('dialog-text');
        const monologueBox = document.getElementById('monologue-box');
        const monologueText = document.getElementById('monologue-text');
        const saveBtn = document.getElementById('save-btn');
        const loadBtn = document.getElementById('load-btn');
        const resetBtn = document.getElementById('reset-btn');
        const leftPortal = document.getElementById('left-portal');
        const rightPortal = document.getElementById('right-portal');

        // ì´ë™ ê´€ë ¨ ë³€ìˆ˜
        const moveSpeed = 3;
        let animationId;

        // DOM ë¡œë“œ ì™„ë£Œ í›„ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing game...');
            
            // ì´ˆê¸°í™”
            updateUI();
            initializeStage(gameState.currentStage);

            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            if (startGameBtn) {
                startGameBtn.addEventListener('click', function() {
                    console.log('Start button clicked!');
                    startGame();
                });
                console.log('Start button event listener added');
            } else {
                console.error('Start button not found!');
            }
            
            document.addEventListener('keydown', handleKeyDown);
            document.addEventListener('keyup', handleKeyUp);
            saveBtn.addEventListener('click', saveGame);
            loadBtn.addEventListener('click', loadGame);
            resetBtn.addEventListener('click', resetGame);
            
            // í¬í„¸ ì´ë²¤íŠ¸
            leftPortal.addEventListener('click', () => goToPreviousStage());
            rightPortal.addEventListener('click', () => goToNextStage());
            
            console.log('All event listeners added');
        });

        function startGame() {
            gameState.gameStarted = true;
            startScreen.classList.add('hidden');
            
            // ìŠ¤í…Œì´ì§€ 1ë¡œ ì´ˆê¸°í™”
            initializeStage(gameState.currentStage);
            updateCharacterPosition(); // ìºë¦­í„° ìœ„ì¹˜ ì—…ë°ì´íŠ¸
            
            setTimeout(() => {
                showMonologue(monologues[0]);
                setTimeout(() => {
                    gameState.story.introShown = true;
                    startMovementLoop();
                }, 3000);
            }, 500);
        }

        function handleKeyDown(event) {
            if (!gameState.gameStarted) return;

            switch(event.code) {
                case 'ArrowUp':
                    gameState.keys.up = true;
                    break;
                case 'ArrowDown':
                    gameState.keys.down = true;
                    break;
                case 'ArrowLeft':
                    gameState.keys.left = true;
                    break;
                case 'ArrowRight':
                    gameState.keys.right = true;
                    break;
                case 'Space':
                    event.preventDefault();
                    handleInteraction();
                    break;
                case 'KeyE':
                    event.preventDefault();
                    checkDrawingSpot();
                    break;
            }
        }

        function handleKeyUp(event) {
            switch(event.code) {
                case 'ArrowUp':
                    gameState.keys.up = false;
                    break;
                case 'ArrowDown':
                    gameState.keys.down = false;
                    break;
                case 'ArrowLeft':
                    gameState.keys.left = false;
                    break;
                case 'ArrowRight':
                    gameState.keys.right = false;
                    break;
            }
        }

        function startMovementLoop() {
            function move() {
                if (!gameState.gameStarted || gameState.character.isDrawing || gameState.character.isInDialog) {
                    animationId = requestAnimationFrame(move);
                    return;
                }

                let moved = false;
                const char = gameState.character;

                if (gameState.keys.up && char.y > 0) {
                    char.y = Math.max(0, char.y - moveSpeed);
                    moved = true;
                }
                if (gameState.keys.down && char.y < window.innerHeight - 60) {
                    char.y = Math.min(window.innerHeight - 60, char.y + moveSpeed);
                    moved = true;
                }
                if (gameState.keys.left && char.x > 0) {
                    char.x = Math.max(0, char.x - moveSpeed);
                    moved = true;
                }
                if (gameState.keys.right && char.x < window.innerWidth - 60) {
                    char.x = Math.min(window.innerWidth - 60, char.x + moveSpeed);
                    moved = true;
                }

                if (moved) {
                    updateCharacterPosition();
                    updateStatus();
                }

                animationId = requestAnimationFrame(move);
            }
            move();
        }

        function updateCharacterPosition() {
            character.style.left = gameState.character.x + 'px';
            character.style.top = gameState.character.y + 'px';
        }

        function updateStatus() {
            const nearNpc = findNearestNPC();
            const nearSpot = findNearestDrawingSpot();
            
            if (nearNpc) {
                statusDisplay.textContent = `${nearNpc.name}ì™€ ëŒ€í™”í•˜ê¸° (ìŠ¤í˜ì´ìŠ¤ë°”)`;
            } else if (nearSpot) {
                statusDisplay.textContent = `${nearSpot.name} ê·¸ë¦¬ê¸° (Eí‚¤)`;
            } else {
                statusDisplay.textContent = 'NPCë‚˜ ê·¸ë¦¼ ì¥ì†Œë¥¼ ì°¾ì•„ë³´ì„¸ìš”!';
            }
        }

        function findNearestNPC() {
            const char = gameState.character;
            const currentStage = gameState.stages[gameState.currentStage];
            
            for (let npc of currentStage.npcs) {
                const npcElement = document.querySelector(`[data-npc="${npc.id}"]`);
                if (!npcElement) continue;
                
                const npcRect = npcElement.getBoundingClientRect();
                const distance = Math.sqrt(
                    Math.pow(char.x - (npcRect.left - 10), 2) + 
                    Math.pow(char.y - (npcRect.top - 10), 2)
                );
                
                if (distance < 100) {
                    return npc;
                }
            }
            return null;
        }

        function findNearestDrawingSpot() {
            const char = gameState.character;
            const currentStage = gameState.stages[gameState.currentStage];
            
            for (let spot of currentStage.drawingSpots) {
                if (spot.used) continue;
                
                const spotElement = document.getElementById(spot.id);
                if (!spotElement) continue;
                
                const spotRect = spotElement.getBoundingClientRect();
                const distance = Math.sqrt(
                    Math.pow(char.x - (spotRect.left - 10), 2) + 
                    Math.pow(char.y - (spotRect.top - 10), 2)
                );
                
                if (distance < 100) {
                    return spot;
                }
            }
            return null;
        }

        function handleInteraction() {
            if (gameState.character.isInDialog) {
                continueDialog();
                return;
            }

            const nearNpc = findNearestNPC();
            if (nearNpc) {
                startDialog(nearNpc.id);
            }
        }

        function startDialog(npcId) {
            const currentStage = gameState.stages[gameState.currentStage];
            const npc = currentStage.npcs.find(n => n.id === npcId);
            if (!npc) return;

            gameState.character.isInDialog = true;
            gameState.story.currentNpc = npc;
            gameState.story.currentDialog = 0;

            showDialog(npc.name, npc.dialogs[0]);

            // NPC ëŒ€í™” ì™„ë£Œ í‘œì‹œ
            if (!npc.talked) {
                npc.talked = true;
                const npcElement = document.querySelector(`[data-npc="${npcId}"]`);
                const indicator = npcElement.querySelector('.npc-indicator');
                if (indicator) {
                    indicator.style.display = 'none';
                }
            }
        }

        function continueDialog() {
            const npc = gameState.story.currentNpc;
            if (!npc) return;

            gameState.story.currentDialog++;
            
            if (gameState.story.currentDialog < npc.dialogs.length) {
                showDialog(npc.name, npc.dialogs[gameState.story.currentDialog]);
            } else {
                endDialog();
            }
        }

        function showDialog(name, text) {
            dialogName.textContent = name;
            dialogText.textContent = text;
            dialogBox.classList.add('show');
        }

        function endDialog() {
            dialogBox.classList.remove('show');
            gameState.character.isInDialog = false;
            gameState.story.currentNpc = null;
            gameState.story.currentDialog = 0;

            // ëœë¤ ë…ë°± í‘œì‹œ
            if (Math.random() < 0.3) {
                const randomMonologue = monologues[Math.floor(Math.random() * monologues.length)];
                setTimeout(() => showMonologue(randomMonologue), 1000);
            }
        }

        function showMonologue(text) {
            monologueText.textContent = text;
            monologueBox.classList.add('show');
            setTimeout(() => {
                monologueBox.classList.remove('show');
            }, 3000);
        }

        function checkDrawingSpot() {
            const nearSpot = findNearestDrawingSpot();
            if (nearSpot && !nearSpot.used) {
                startDrawing(nearSpot);
            }
        }

        async function startDrawing(spot) {
            gameState.character.isDrawing = true;
            statusDisplay.textContent = `${spot.name} ê·¸ë¦¬ëŠ” ì¤‘...`;
            
            showMessage(`ğŸ¨ ${spot.location}ì˜ ${spot.name}ì„(ë¥¼) ê·¸ë¦¬ê¸° ì‹œì‘í•©ë‹ˆë‹¤!`);
            
            // ê·¸ë¦¼ ê·¸ë¦¬ê¸° ì§„í–‰ ë°” ì• ë‹ˆë©”ì´ì…˜
            progressBar.style.width = '0%';
            const duration = 4000;
            const steps = 100;
            const stepDuration = duration / steps;
            
            for (let i = 0; i <= steps; i++) {
                progressBar.style.width = (i / steps * 100) + '%';
                await new Promise(resolve => setTimeout(resolve, stepDuration));
                
                if (!gameState.character.isDrawing) return; // ì¤‘ë‹¨ëœ ê²½ìš°
            }

            completeDrawing(spot);
        }

        function completeDrawing(spot) {
            spot.used = true;
            gameState.character.gold += spot.reward;
            gameState.character.artworks += 1;
            gameState.character.totalArtworks += 1;
            gameState.character.isDrawing = false;

            updateUI();
            updatePortals(); // í¬í„¸ ìƒíƒœ ì—…ë°ì´íŠ¸
            
            // ì‚¬ìš©ëœ ìŠ¤íŒŸ í‘œì‹œ
            const spotElement = document.getElementById(spot.id);
            spotElement.classList.add('used');
            spotElement.innerHTML = 'âœ…';
            
            // ìºë¦­í„° ë°”ìš´ìŠ¤ ì• ë‹ˆë©”ì´ì…˜
            character.classList.add('bounce');
            setTimeout(() => character.classList.remove('bounce'), 600);

            showMessage(`ğŸ‰ "${spot.name}" ì‘í’ˆ ì™„ì„±!\n${spot.reward} ê³¨ë“œ íšë“!`);

            // ë…ë°±
            setTimeout(() => {
                showMonologue(`${spot.location}ì˜ ${spot.name}... ì •ë§ ì•„ë¦„ë‹¤ìš´ ì‘í’ˆì´ ë‚˜ì™”ì–´!`);
            }, 2000);

            // í˜„ì¬ ìŠ¤í…Œì´ì§€ì˜ ëª¨ë“  ìŠ¤íŒŸì„ ì™„ë£Œí–ˆëŠ”ì§€ í™•ì¸
            const currentStage = gameState.stages[gameState.currentStage];
            if (currentStage.drawingSpots.every(s => s.used)) {
                setTimeout(() => {
                    if (gameState.currentStage < gameState.maxStage) {
                        showMessage(`ğŸŒŸ ${currentStage.name} ì™„ë£Œ! ì˜¤ë¥¸ìª½ ë¬¸ìœ¼ë¡œ ë‹¤ìŒ ìŠ¤í…Œì´ì§€ì— ë„ì „í•˜ì„¸ìš”!`);
                        setTimeout(() => {
                            showMonologue("ì´ ìŠ¤í…Œì´ì§€ì˜ ëª¨ë“  ì‘í’ˆì„ ì™„ì„±í–ˆë‹¤! ë‹¤ìŒ ëª¨í—˜ì´ ê¸°ë‹¤ë¦¬ê³  ìˆì–´!");
                        }, 3000);
                    } else {
                        showMessage(`ğŸ† ì¶•í•˜í•©ë‹ˆë‹¤! ëª¨ë“  ìŠ¤í…Œì´ì§€ë¥¼ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤!\nì´ ${gameState.character.totalArtworks}ê°œ ì‘í’ˆ, ${gameState.character.gold} ê³¨ë“œ!`);
                        setTimeout(() => {
                            showMonologue("ë“œë””ì–´ ëª¨ë“  ëª¨í—˜ì„ ì™„ë£Œí–ˆë‹¤! ì´ì œ ì§„ì •í•œ ì „ì„¤ì˜ í™”ê°€ê°€ ë˜ì—ˆì–´!");
                        }, 3000);
                    }
                }, 3000);
            }

            statusDisplay.textContent = 'ë‹¤ë¥¸ ê·¸ë¦¼ ì¥ì†Œë¥¼ ì°¾ì•„ë³´ì„¸ìš”!';
            progressBar.style.width = '0%';
        }

        function updateUI() {
            goldDisplay.textContent = gameState.character.gold;
            artworksDisplay.textContent = gameState.character.artworks;
            totalArtworksDisplay.textContent = gameState.character.totalArtworks;
        }

        function showMessage(text) {
            messageBox.textContent = text;
            messageBox.classList.add('show');
            setTimeout(() => {
                messageBox.classList.remove('show');
            }, 3000);
        }

        function saveGame() {
            const saveData = {
                currentStage: gameState.currentStage,
                character: gameState.character,
                stages: gameState.stages,
                story: gameState.story,
                timestamp: new Date().toISOString()
            };
            
            const saveString = JSON.stringify(saveData);
            
            // ê°„ë‹¨í•œ ë‹¤ìš´ë¡œë“œ ë°©ì‹
            const blob = new Blob([saveString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'grimjaengi_save.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showMessage('ğŸ’¾ ê²Œì„ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
        }

        function loadGame() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        try {
                            const saveData = JSON.parse(e.target.result);
                            
                            // ë°ì´í„° ë³µì›
                            gameState.currentStage = saveData.currentStage;
                            gameState.character = saveData.character;
                            gameState.stages = saveData.stages;
                            gameState.story = saveData.story;
                            
                            // ìŠ¤í…Œì´ì§€ì™€ UI ì—…ë°ì´íŠ¸
                            initializeStage(gameState.currentStage);
                            updateCharacterPosition();
                            updateUI();
                            
                            if (!gameState.gameStarted) {
                                startScreen.classList.add('hidden');
                                gameState.gameStarted = true;
                                startMovementLoop();
                            }
                            
                            showMessage('ğŸ“‚ ê²Œì„ì´ ë¶ˆëŸ¬ì™€ì¡ŒìŠµë‹ˆë‹¤!');
                        } catch (error) {
                            showMessage('âŒ ì €ì¥ íŒŒì¼ì„ ì½ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        }

        function resetGame() {
            if (confirm('ì •ë§ë¡œ ê²Œì„ì„ ì²˜ìŒë¶€í„° ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                // ê²Œì„ ìƒíƒœ ì™„ì „ ì´ˆê¸°í™”
                gameState.gameStarted = false;
                gameState.currentStage = 1;
                gameState.character = {
                    x: 100,
                    y: 100,
                    gold: 0,
                    artworks: 0,
                    totalArtworks: 0,
                    isDrawing: false,
                    isInDialog: false
                };
                
                // ëª¨ë“  ìŠ¤í…Œì´ì§€ ë°ì´í„° ì´ˆê¸°í™”
                Object.values(gameState.stages).forEach(stage => {
                    stage.npcs.forEach(npc => npc.talked = false);
                    stage.drawingSpots.forEach(spot => spot.used = false);
                });
                
                gameState.story = {
                    introShown: false,
                    currentDialog: 0,
                    currentNpc: null
                };

                // UI ì´ˆê¸°í™”
                startScreen.classList.remove('hidden');
                dialogBox.classList.remove('show');
                monologueBox.classList.remove('show');
                stageTransition.classList.remove('active');
                
                // ìŠ¤í…Œì´ì§€ 1ë¡œ ì´ˆê¸°í™”
                initializeStage(1);
                updateCharacterPosition();
                updateUI();
                progressBar.style.width = '0%';
                statusDisplay.textContent = 'ë§ˆì„ì„ íƒí—˜í•´ë³´ì„¸ìš”!';
                
                // ì• ë‹ˆë©”ì´ì…˜ ì¤‘ì§€
                if (animationId) {
                    cancelAnimationFrame(animationId);
                }
                
                showMessage('ğŸ”„ ê²Œì„ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤!');
            }
        }

        // ìœˆë„ìš° ë¦¬ì‚¬ì´ì¦ˆ ëŒ€ì‘
        window.addEventListener('resize', () => {
            const char = gameState.character;
            char.x = Math.min(char.x, window.innerWidth - 60);
            char.y = Math.min(char.y, window.innerHeight - 60);
            updateCharacterPosition();
        });
    </script>
</body>
</html>